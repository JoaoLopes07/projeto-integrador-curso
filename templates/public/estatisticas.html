{% extends "base.html" %}
{% load static %}

{% block title %}Dados do Mercado | ACJOGOS{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .stats-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .stats-title {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #fff 0%, #a742f5 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }


  .metric-card {
    background: rgba(30, 30, 30, 0.6);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1.5rem;
    padding: 2rem;
    text-align: center;
    transition: transform 0.3s ease, border-color 0.3s;
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  .metric-card:hover {
    transform: translateY(-5px);
    border-color: #a742f5;
    box-shadow: 0 10px 30px rgba(167, 66, 245, 0.2);
  }

  .metric-icon-bg {
    position: absolute;
    top: -20px;
    right: -20px;
    font-size: 8rem;
    opacity: 0.05;
    transform: rotate(15deg);
  }

  .metric-value {
    font-size: 3.5rem;
    font-weight: 800;
    color: #fff;
    line-height: 1;
    margin-bottom: 0.5rem;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
  }

  .metric-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: #d4a5ff;
    font-weight: 600;
  }


  .chart-container {
    background: rgba(20, 20, 20, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 1.5rem;
    padding: 1.5rem;
    height: 100%;
    min-height: 400px;
    display: flex;
    flex-direction: column;
  }

  .chart-title {
    color: white;
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
  }

  .chart-title i {
    margin-right: 10px;
    color: #a742f5;
  }


  .state-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .state-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    transition: background 0.2s;
  }

  .state-item:last-child {
    border-bottom: none;
  }

  .state-item:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .state-badge {
    background: rgba(167, 66, 245, 0.15);
    color: #d4a5ff;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
  }
</style>

<div class="container py-5">

  <div class="stats-header">
    <span
      class="badge bg-white bg-opacity-10 border border-white border-opacity-25 text-white mb-3 px-3 py-2 rounded-pill">
      <i class="fas fa-chart-line me-2"></i>Transparência
    </span>
    <h1 class="stats-title">Panorama do Mercado</h1>
    <p class="text-white-50 lead mx-auto" style="max-width: 600px;">
      Dados em tempo real sobre o crescimento da indústria de jogos no Rio de Janeiro.
    </p>
  </div>

  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="metric-card">
        <i class="fas fa-building metric-icon-bg"></i>
        <div class="metric-value">{{ total_companies }}</div>
        <div class="metric-label">Empresas Mapeadas</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="metric-card">
        <i class="fas fa-gamepad metric-icon-bg"></i>
        <div class="metric-value">{{ total_projects }}</div>
        <div class="metric-label">Projetos Publicados</div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">

    <div class="col-lg-8">
      <div class="chart-container">
        <h4 class="chart-title"><i class="fas fa-city"></i> Top Cidades (Concentração)</h4>
        <div style="flex-grow: 1; position: relative;">
          <canvas id="cityChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="chart-container">
        <h4 class="chart-title"><i class="fas fa-tasks"></i> Status dos Projetos</h4>
        <div style="flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center;">
          <canvas id="statusChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="chart-container" style="min-height: auto;">
        <h4 class="chart-title"><i class="fas fa-map-marked-alt"></i> Distribuição por Estado</h4>
        <ul class="state-list">
          {% for item in companies_por_estado %}
          <li class="state-item">
            <div class="d-flex align-items-center">
              <div class="rounded-circle bg-white bg-opacity-10 d-flex align-items-center justify-content-center me-3"
                style="width: 35px; height: 35px;">
                <i class="fas fa-map-pin small"></i>
              </div>
              <span class="fw-bold text-white">{{ item.estado }}</span>
            </div>
            <span class="state-badge">{{ item.total }} Empresas</span>
          </li>
          {% empty %}
          <li class="state-item text-muted text-center py-3">Sem dados registrados</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<script>

  Chart.defaults.color = '#888';
  Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';


  const cityLabels = [{% for item in companies_por_cidade %}"{{ item.cidade|escapejs }}", {% endfor %}];
  const cityData = [{% for item in companies_por_cidade %}{{ item.total }},{% endfor %}];

  const ctxCity = document.getElementById('cityChart').getContext('2d');
  new Chart(ctxCity, {
    type: 'bar',
    data: {
      labels: cityLabels,
      datasets: [{
        label: 'Empresas',
        data: cityData,
        backgroundColor: 'rgba(167, 66, 245, 0.6)', // Roxo Neon
        borderColor: '#a742f5',
        borderWidth: 1,
        borderRadius: 5,
        hoverBackgroundColor: '#a742f5'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } },
        x: { grid: { display: false } }
      }
    }
  });


  const statusLabels = [{% for item in projects_por_status %}"{{ item.status|title|escapejs }}", {% endfor %}];
  const statusData = [{% for item in projects_por_status %}{{ item.total }}, {% endfor %}];

  const ctxStatus = document.getElementById('statusChart').getContext('2d');
  new Chart(ctxStatus, {
    type: 'doughnut',
    data: {
      labels: statusLabels,
      datasets: [{
        data: statusData,
        backgroundColor: [
          '#2dce89',
          '#a742f5',
          '#FF6B6B',
          '#11cdef',
          '#fb6340'
        ],
        borderWidth: 0,
        hoverOffset: 10
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#fff', padding: 20 }
        }
      },
      cutout: '70%'
    }
  });
</script>
{% endblock %}