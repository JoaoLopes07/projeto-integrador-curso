{% extends "base.html" %}
{% block title %}Diretório de Empresas | ACJOGOS{% endblock %}

{% block content %}
<style>
  .directory-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .directory-title {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #fff 0%, #a742f5 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 0.5rem;
  }

  .filter-card {
    background: rgba(30, 30, 30, 0.6);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 3rem;
  }

  .form-select-dark {
    background-color: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    border-radius: 0.5rem;
  }

  .form-select-dark:focus {
    background-color: rgba(0, 0, 0, 0.5);
    border-color: #a742f5;
    box-shadow: 0 0 0 3px rgba(167, 66, 245, 0.2);
    color: #fff;
  }

  .form-select-dark:disabled {
    background-color: rgba(0, 0, 0, 0.1);
    color: #666;
    cursor: not-allowed;
  }

  .company-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 1rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  .company-card:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.05);
    border-color: #a742f5;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .company-icon {
    width: 50px;
    height: 50px;
    background: rgba(167, 66, 245, 0.1);
    color: #d4a5ff;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  .badge-location {
    background: rgba(255, 255, 255, 0.1);
    color: #ccc;
    font-weight: 500;
    font-size: 0.8rem;
    padding: 0.4em 0.8em;
    border-radius: 2rem;
  }

  .project-count {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 0.8rem;
    color: #a742f5;
    font-weight: 700;
    background: rgba(167, 66, 245, 0.1);
    padding: 0.3em 0.8em;
    border-radius: 0.5rem;
  }
</style>

<div class="container py-5">

  <div class="directory-header">
    <h1 class="directory-title">Diretório Oficial</h1>
    <p class="text-muted lead">Conheça as empresas e estúdios que movem o mercado.</p>
  </div>

  <div class="filter-card">
    <form method="get" class="row g-3 align-items-end">

      {# ===== ESTADO ===== #}
      <div class="col-md-3">
        <label class="form-label text-white-50 small text-uppercase fw-bold">Estado</label>
        <select name="estado" id="select-estado" class="form-select form-select-dark">
          <option value="">Selecione um Estado</option>
          {% for uf in estados_disponiveis %}
          <option value="{{ uf }}" {% if filters.estado == uf %}selected{% endif %}>{{ uf }}</option>
          {% endfor %}
        </select>
      </div>

      {# ===== CIDADE (Controlado por JS) ===== #}
      <div class="col-md-3">
        <label class="form-label text-white-50 small text-uppercase fw-bold">Cidade</label>
        <select name="cidade" id="select-cidade" class="form-select form-select-dark" disabled>
          <option value="">Selecione primeiro o Estado</option>
        </select>
      </div>

      {# ===== STATUS ===== #}
      <div class="col-md-3">
        <label class="form-label text-white-50 small text-uppercase fw-bold">Filtro de Projetos</label>
        <select name="status" class="form-select form-select-dark">
          <option value="">Qualquer Status</option>
          {% for value, label in status_choices %}
          <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      {# ===== BOTÕES ===== #}
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary w-100 fw-bold shadow" type="submit">
          <i class="fas fa-filter me-2"></i>Filtrar
        </button>
        {% if filters.estado or filters.cidade or filters.status %}
        <a href="{% url 'public:diretorio' %}" class="btn btn-outline-light w-auto" title="Limpar Filtros">
          <i class="fas fa-times"></i>
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="d-flex align-items-center justify-content-between mb-4">
    <h5 class="text-white mb-0">
      <span class="text-primary fw-bold">{{ companies|length }}</span> empresas encontradas
    </h5>
    {% if filters.status %}
    <span class="badge bg-primary bg-opacity-25 text-primary border border-primary border-opacity-25">
      Filtrando por status: {{ filters.status }}
    </span>
    {% endif %}
  </div>

  <div class="row g-4">
    {% for c in companies %}
    <div class="col-md-6 col-lg-4">
      <div class="company-card">
        <div class="company-icon"><i class="fas fa-building"></i></div>

        {% if c.projects_count > 0 %}
        <div class="project-count" title="Projetos Registrados">
          <i class="fas fa-gamepad me-1"></i> {{ c.projects_count }}
        </div>
        {% endif %}

        <h4 class="fw-bold text-white mb-1">{{ c.nome_fantasia }}</h4>
        <p class="text-muted small mb-3 text-truncate">{{ c.razao_social }}</p>

        <div class="d-flex align-items-center gap-2 mb-4">
          <span class="badge-location">
            <i class="fas fa-map-marker-alt me-1 text-danger"></i> {{ c.cidade }} / {{ c.estado }}
          </span>
        </div>

        <div
          class="border-top border-white border-opacity-10 pt-3 mt-auto d-flex justify-content-between align-items-center">
          {% if c.site %}
          <a href="{{ c.site }}" target="_blank"
            class="text-decoration-none text-primary small fw-bold hover-brightness">
            <i class="fas fa-globe me-1"></i> Visitar Site
          </a>
          {% else %}
          <span class="text-muted small opacity-50"><i class="fas fa-globe me-1"></i> Sem site</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="text-center py-5 rounded-4 border border-white border-opacity-10 bg-dark bg-opacity-50">
        <div class="mb-3 opacity-25"><i class="fas fa-search fa-4x text-white"></i></div>
        <h4 class="text-white fw-bold">Nenhum resultado encontrado</h4>
        <p class="text-muted">Tente ajustar os filtros ou cadastre novas empresas.</p>
        <a href="{% url 'public:diretorio' %}" class="btn btn-outline-light mt-3">Limpar Filtros</a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {

    const cityMap = JSON.parse('{{ mapa_cidades_json|escapejs }}');

    const stateSelect = document.getElementById('select-estado');
    const citySelect = document.getElementById('select-cidade');


    const currentCity = "{{ filters.cidade|default:'' }}";

    function updateCities() {
      const selectedState = stateSelect.value;


      citySelect.innerHTML = '<option value="">Todas as Cidades</option>';

      if (selectedState && cityMap[selectedState]) {

        citySelect.disabled = false;


        cityMap[selectedState].forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;


          if (city === currentCity) {
            option.selected = true;
          }
          citySelect.appendChild(option);
        });
      } else {

        citySelect.disabled = true;
        citySelect.innerHTML = '<option value="">Selecione primeiro o Estado</option>';
      }
    }


    stateSelect.addEventListener('change', updateCities);


    if (stateSelect.value) {
      updateCities();
    }
  });
</script>
{% endblock %}