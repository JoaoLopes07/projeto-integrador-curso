{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-9">

            <div class="card shadow-lg mb-4 border-0">
                <div
                    class="card-header py-3 bg-primary text-white d-flex flex-row align-items-center justify-content-between rounded-top">
                    <h6 class="m-0 fw-bold">
                        {% if company %}
                        <i class="fas fa-edit me-2"></i>Editar Empresa
                        {% else %}
                        <i class="fas fa-building me-2"></i>Nova Empresa
                        {% endif %}
                    </h6>
                    <a href="{% url 'company-list' %}" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </a>
                </div>

                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}

                        {% if form.errors %}
                        <div class="alert alert-danger shadow-sm border-start border-danger border-4">
                            <h6 class="alert-heading fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Atenção!
                            </h6>
                            <p class="mb-0 small">Verifique os erros abaixo antes de salvar.</p>
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="bg-light p-4 rounded-3 border mb-4">
                            <h6 class="text-primary font-weight-bold text-uppercase small mb-3 border-bottom pb-2">
                                <i class="fas fa-id-card me-2"></i>Dados da Empresa
                            </h6>

                            <div class="row gx-3 mb-3">
                                <div class="col-md-6">
                                    <label class="small mb-1 fw-bold text-secondary">CNPJ</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i
                                                class="fas fa-hashtag text-muted"></i></span>
                                        <input type="text" name="cnpj" id="id_cnpj" class="form-control"
                                            value="{{ form.cnpj.value|default:'' }}" required
                                            placeholder="00.000.000/0000-00">
                                    </div>
                                    {% if form.cnpj.errors %}<div class="text-danger small">{{ form.cnpj.errors.0 }}
                                    </div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="small mb-1 fw-bold text-secondary">Razão Social</label>
                                    <input type="text" name="razao_social" id="id_razao_social" class="form-control"
                                        value="{{ form.razao_social.value|default:'' }}" required>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="small mb-1 fw-bold text-secondary">Nome Fantasia</label>
                                <input type="text" name="nome_fantasia" id="id_nome_fantasia"
                                    class="form-control form-control-lg fw-bold text-dark"
                                    value="{{ form.nome_fantasia.value|default:'' }}" required
                                    placeholder="Como a empresa é conhecida">
                            </div>
                        </div>

                        <div class="bg-light p-4 rounded-3 border mb-4">
                            <h6 class="text-primary font-weight-bold text-uppercase small mb-3 border-bottom pb-2">
                                <i class="fas fa-address-book me-2"></i>Canais de Contato
                            </h6>

                            <div class="row gx-3 mb-3">
                                <div class="col-md-6">
                                    <label class="small mb-1 fw-bold text-secondary">Email Corporativo</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i
                                                class="fas fa-envelope text-muted"></i></span>
                                        <input type="email" name="email_contato" id="id_email_contato"
                                            class="form-control" value="{{ form.email_contato.value|default:'' }}"
                                            required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="small mb-1 fw-bold text-secondary">Telefone</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i
                                                class="fas fa-phone text-muted"></i></span>
                                        <input type="text" name="telefone" id="id_telefone" class="form-control"
                                            value="{{ form.telefone.value|default:'' }}" required
                                            placeholder="(21) 99999-9999">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="small mb-1 fw-bold text-secondary">Site (Opcional)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i
                                            class="fas fa-globe text-muted"></i></span>
                                    <input type="url" name="site" id="id_site" class="form-control"
                                        value="{{ form.site.value|default:'' }}"
                                        placeholder="https://www.suaempresa.com.br">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-3 border border-2 shadow-sm mb-4 position-relative">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h6 class="text-primary font-weight-bold text-uppercase small mb-0">
                                    <i class="fas fa-map-marked-alt me-2"></i>Localização Automática
                                </h6>
                                <span class="badge bg-success"><i class="fas fa-mouse-pointer me-1"></i>Clique no
                                    mapa</span>
                            </div>

                            <p class="small text-muted mb-2">
                                Encontre sua empresa no mapa abaixo. Ao clicar ou arrastar o pino, <strong>o endereço
                                    será preenchido automaticamente</strong>.
                            </p>

                            <div id="map-picker" style="height: 400px; width: 100%; border-radius: 8px; z-index: 1;"
                                class="border"></div>

                            <div class="row gx-3 mt-3 bg-light p-2 rounded mx-0">
                                <div class="col-md-6">
                                    <label class="small mb-1 fw-bold text-secondary">Latitude</label>
                                    {{ form.latitude }}
                                </div>
                                <div class="col-md-6">
                                    <label class="small mb-1 fw-bold text-secondary">Longitude</label>
                                    {{ form.longitude }}
                                </div>
                            </div>
                        </div>

                        <div class="bg-light p-4 rounded-3 border mb-4">
                            <div class="d-flex align-items-center justify-content-between border-bottom pb-2 mb-3">
                                <h6 class="text-primary font-weight-bold text-uppercase small mb-0">
                                    <i class="fas fa-map-marker-alt me-2"></i>Endereço Físico
                                </h6>
                            </div>

                            <div class="row gx-3 mb-3">
                                <div class="col-md-3">
                                    <label class="small mb-1 fw-bold text-secondary">CEP</label>
                                    <input type="text" name="cep" id="id_cep" class="form-control"
                                        value="{{ form.cep.value|default:'' }}" required placeholder="00000-000">
                                </div>
                                <div class="col-md-7">
                                    <label class="small mb-1 fw-bold text-secondary">Endereço (Rua/Av)</label>
                                    <input type="text" name="endereco" id="id_endereco" class="form-control"
                                        value="{{ form.endereco.value|default:'' }}" required>
                                </div>
                                <div class="col-md-2">
                                    <label class="small mb-1 fw-bold text-secondary">Número</label>
                                    <input type="text" name="numero" id="id_numero" class="form-control"
                                        value="{{ form.numero.value|default:'' }}" required>
                                </div>
                            </div>

                            <div class="row gx-3 mb-3">
                                <div class="col-md-4">
                                    <label class="small mb-1 fw-bold text-secondary">Bairro</label>
                                    <input type="text" name="bairro" id="id_bairro" class="form-control"
                                        value="{{ form.bairro.value|default:'' }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="small mb-1 fw-bold text-secondary">Cidade</label>
                                    <input type="text" name="cidade" id="id_cidade" class="form-control"
                                        value="{{ form.cidade.value|default:'' }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="small mb-1 fw-bold text-secondary">Estado (UF)</label>
                                    <input type="text" name="estado" id="id_estado" class="form-control text-uppercase"
                                        value="{{ form.estado.value|default:'' }}" required maxlength="2">
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="small mb-1 fw-bold text-secondary">Complemento (Opcional)</label>
                                <input type="text" name="complemento" id="id_complemento" class="form-control"
                                    value="{{ form.complemento.value|default:'' }}">
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg shadow fw-bold py-3">
                                <i class="fas fa-save me-2"></i>SALVAR DADOS DA EMPRESA
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const elements = {
            lat: document.getElementById('id_latitude'),
            lng: document.getElementById('id_longitude'),
            cep: document.getElementById('id_cep'),
            endereco: document.getElementById('id_endereco'),
            numero: document.getElementById('id_numero'),
            bairro: document.getElementById('id_bairro'),
            cidade: document.getElementById('id_cidade'),
            estado: document.getElementById('id_estado'),
            map: document.getElementById('map-picker')
        };

        var initialLat = elements.lat.value ? parseFloat(elements.lat.value) : -22.9068;
        var initialLng = elements.lng.value ? parseFloat(elements.lng.value) : -43.1729;
        var initialZoom = elements.lat.value ? 16 : 10;

        var map = L.map('map-picker').setView([initialLat, initialLng], initialZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var marker;

        if (elements.lat.value && elements.lng.value) {
            marker = L.marker([initialLat, initialLng], {
                icon: redIcon,
                draggable: true
            }).addTo(map);
            setupMarkerEvents(marker);
        }

        async function fetchAddress(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;

            document.body.style.cursor = "wait";
            elements.map.style.opacity = "0.7";

            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'IntranetACJOGOS/1.0' }
                });
                const data = await response.json();

                if (data && data.address) {
                    const addr = data.address;

                    if (elements.cep) elements.cep.value = addr.postcode || '';
                    if (elements.endereco) elements.endereco.value = addr.road || '';
                    // Número às vezes falha na API, mas tentamos
                    if (elements.numero) elements.numero.value = addr.house_number || '';
                    if (elements.bairro) elements.bairro.value = addr.suburb || addr.neighbourhood || addr.residential || '';
                    if (elements.cidade) elements.cidade.value = addr.city || addr.town || addr.municipality || '';

                    if (elements.estado && addr.state) {
                        elements.estado.value = convertStateToSigla(addr.state);
                    }
                }
            } catch (error) {
                console.error("Erro ao buscar endereço:", error);
            } finally {
                document.body.style.cursor = "default";
                elements.map.style.opacity = "1";
            }
        }

        function convertStateToSigla(stateName) {
            const map = {
                "Rio de Janeiro": "RJ", "São Paulo": "SP", "Minas Gerais": "MG", "Espírito Santo": "ES",
                "Bahia": "BA", "Distrito Federal": "DF", "Paraná": "PR", "Rio Grande do Sul": "RS",
                "Santa Catarina": "SC", "Pernambuco": "PE", "Ceará": "CE", "Goiás": "GO"
            };
            return map[stateName] || stateName.substring(0, 2).toUpperCase();
        }

        function setupMarkerEvents(markerInstance) {
            markerInstance.on('dragend', function (event) {
                var position = markerInstance.getLatLng();
                updateInputs(position.lat, position.lng);
                fetchAddress(position.lat, position.lng);
            });
        }

        function updateInputs(lat, lng) {
            elements.lat.value = lat.toFixed(6);
            elements.lng.value = lng.toFixed(6);
        }

        map.on('click', function (e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng], {
                    icon: redIcon,
                    draggable: true
                }).addTo(map);
                setupMarkerEvents(marker);
            }

            updateInputs(lat, lng);
            fetchAddress(lat, lng);
        });
    });
</script>
{% endblock %}