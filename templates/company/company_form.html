{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    .form-section-title {
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        font-weight: 700;
        color: #d4a5ff;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .form-section-title::after {
        content: '';
        flex-grow: 1;
        height: 1px;
        background: linear-gradient(90deg, rgba(167, 66, 245, 0.5), transparent);
    }

    .glass-card {
        background: rgba(35, 35, 35, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 1rem;
        padding: 2.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .form-control,
    .input-group-text {
        background-color: #2b2b2b !important;
        border: 1px solid #555 !important;
        color: #ffffff !important;
        font-weight: 500;
    }

    .form-control:focus {
        background-color: #333 !important;
        border-color: #a742f5 !important;
        box-shadow: 0 0 0 3px rgba(167, 66, 245, 0.25);
    }

    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    .form-label {
        color: #e0e0e0;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .map-frame {
        border: 2px solid rgba(167, 66, 245, 0.4);
        border-radius: 1rem;
        overflow: hidden;
    }
</style>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h1 class="h3 fw-bold mb-1" style="color: #ffffff; text-shadow: 0 0 15px rgba(167, 66, 245, 0.6);">
                        {% if company %}
                        Editando: {{ company.nome_fantasia }}
                        {% else %}
                        Nova Empresa
                        {% endif %}
                    </h1>
                    <p class="text-white-50 small">Preencha os dados institucionais e de localização.</p>
                </div>
                <a href="{% url 'company-list' %}" class="btn btn-outline-light btn-sm px-3">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>

            <form method="post">
                {% csrf_token %}

                {% if form.errors %}
                <div class="alert alert-danger mb-4 shadow-sm border-danger">
                    <h6 class="fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Atenção</h6>
                    <ul class="mb-0 small ps-3">
                        {% for field in form %}
                        {% for error in field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                        {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <div class="glass-card">
                    <div class="form-section-title">
                        <i class="fas fa-rocket fa-lg"></i> Informações Corporativas
                    </div>

                    <div class="row g-4">
                        <div class="col-md-8">
                            <label class="form-label">Nome Fantasia</label>
                            <input type="text" name="nome_fantasia" id="id_nome_fantasia"
                                class="form-control form-control-lg fs-5"
                                value="{{ form.nome_fantasia.value|default:'' }}" required
                                placeholder="Ex: Studio Games RJ">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CNPJ</label>
                            <input type="text" name="cnpj" id="id_cnpj" class="form-control form-control-lg fs-5"
                                value="{{ form.cnpj.value|default:'' }}" required placeholder="00.000.000/0000-00">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Razão Social</label>
                            <input type="text" name="razao_social" id="id_razao_social" class="form-control"
                                value="{{ form.razao_social.value|default:'' }}" required>
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="form-section-title">
                        <i class="fas fa-envelope fa-lg"></i> Canais de Contato
                    </div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Email Corporativo</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary border-secondary text-white"><i
                                        class="fas fa-at"></i></span>
                                <input type="email" name="email_contato" id="id_email_contato" class="form-control"
                                    value="{{ form.email_contato.value|default:'' }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefone / WhatsApp</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary border-secondary text-white"><i
                                        class="fas fa-phone"></i></span>
                                <input type="text" name="telefone" id="id_telefone" class="form-control"
                                    value="{{ form.telefone.value|default:'' }}" required placeholder="(21) 99999-9999">
                            </div>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Website (Opcional)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary border-secondary text-white"><i
                                        class="fas fa-globe"></i></span>
                                <input type="url" name="site" id="id_site" class="form-control"
                                    value="{{ form.site.value|default:'' }}"
                                    placeholder="https://www.suaempresa.com.br">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="form-section-title">
                        <i class="fas fa-share-alt fa-lg"></i> Redes Sociais e Links
                    </div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">LinkedIn</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary border-secondary text-white"><i
                                        class="fab fa-linkedin"></i></span>
                                <input type="url" name="link_linkedin" class="form-control"
                                    value="{{ form.link_linkedin.value|default:'' }}"
                                    placeholder="https://linkedin.com/company/...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Instagram</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary border-secondary text-white"><i
                                        class="fab fa-instagram"></i></span>
                                <input type="url" name="link_instagram" class="form-control"
                                    value="{{ form.link_instagram.value|default:'' }}"
                                    placeholder="https://instagram.com/...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Facebook</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary border-secondary text-white"><i
                                        class="fab fa-facebook"></i></span>
                                <input type="url" name="link_facebook" class="form-control"
                                    value="{{ form.link_facebook.value|default:'' }}"
                                    placeholder="https://facebook.com/...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">X (Twitter)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-secondary border-secondary text-white"><i
                                        class="fab fa-twitter"></i></span>
                                <input type="url" name="link_twitter" class="form-control"
                                    value="{{ form.link_twitter.value|default:'' }}" placeholder="https://x.com/...">
                            </div>
                        </div>
                        <div class="col-md-12">
                            <hr class="border-secondary opacity-25 my-2">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-warning"><i class="fas fa-briefcase me-1"></i> Página de Vagas
                                / Carreiras</label>
                            <input type="url" name="link_vagas" class="form-control"
                                value="{{ form.link_vagas.value|default:'' }}"
                                placeholder="Link para sua página de 'Trabalhe Conosco'">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-info"><i class="fas fa-images me-1"></i> Portfólio / Press
                                Kit</label>
                            <input type="url" name="link_portfolio" class="form-control"
                                value="{{ form.link_portfolio.value|default:'' }}"
                                placeholder="Link externo para portfólio (Behance, ArtStation, Drive)">
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div class="form-section-title mb-0" style="flex-grow: 1;">
                            <i class="fas fa-map-marked-alt fa-lg"></i> Geolocalização
                        </div>
                        <span class="badge bg-primary border border-light">
                            <i class="fas fa-mouse-pointer me-1"></i> Mapa Interativo
                        </span>
                    </div>

                    <p class="text-white-50 mb-3">Clique no mapa ou arraste o pino. O endereço será preenchido
                        automaticamente.</p>

                    <div class="map-frame mb-4 shadow-lg">
                        <div id="map-picker" style="height: 400px; width: 100%; z-index: 1;"></div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">CEP</label>
                            <input type="text" name="cep" id="id_cep" class="form-control"
                                value="{{ form.cep.value|default:'' }}" required placeholder="00000-000">
                        </div>
                        <div class="col-md-7">
                            <label class="form-label">Logradouro</label>
                            <input type="text" name="endereco" id="id_endereco" class="form-control"
                                value="{{ form.endereco.value|default:'' }}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Número</label>
                            <input type="text" name="numero" id="id_numero" class="form-control"
                                value="{{ form.numero.value|default:'' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bairro</label>
                            <input type="text" name="bairro" id="id_bairro" class="form-control"
                                value="{{ form.bairro.value|default:'' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cidade</label>
                            <input type="text" name="cidade" id="id_cidade" class="form-control"
                                value="{{ form.cidade.value|default:'' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Estado</label>
                            <input type="text" name="estado" id="id_estado" class="form-control text-uppercase"
                                value="{{ form.estado.value|default:'' }}" required maxlength="2">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Complemento</label>
                            <input type="text" name="complemento" id="id_complemento" class="form-control"
                                value="{{ form.complemento.value|default:'' }}">
                        </div>
                    </div>

                    <div class="row g-3 mt-2" style="opacity: 0.6;">
                        <div class="col-6">
                            <small class="text-muted">Latitude</small>
                            {{ form.latitude }}
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Longitude</small>
                            {{ form.longitude }}
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 mt-5 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg py-3 shadow fw-bold text-uppercase fs-6">
                        <i class="fas fa-check-circle me-2"></i> Salvar Cadastro
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const elements = {
            lat: document.getElementById('id_latitude'),
            lng: document.getElementById('id_longitude'),
            cep: document.getElementById('id_cep'),
            endereco: document.getElementById('id_endereco'),
            numero: document.getElementById('id_numero'),
            bairro: document.getElementById('id_bairro'),
            cidade: document.getElementById('id_cidade'),
            estado: document.getElementById('id_estado'),
            map: document.getElementById('map-picker')
        };

        if (elements.lat) elements.lat.classList.add('form-control', 'form-control-sm', 'bg-dark', 'text-white-50');
        if (elements.lng) elements.lng.classList.add('form-control', 'form-control-sm', 'bg-dark', 'text-white-50');

        var initialLat = elements.lat.value ? parseFloat(elements.lat.value) : -22.9068;
        var initialLng = elements.lng.value ? parseFloat(elements.lng.value) : -43.1729;
        var initialZoom = elements.lat.value ? 16 : 10;

        var map = L.map('map-picker').setView([initialLat, initialLng], initialZoom);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        var marker;

        if (elements.lat.value && elements.lng.value) {
            marker = L.marker([initialLat, initialLng], {
                icon: redIcon,
                draggable: true
            }).addTo(map);
            setupMarkerEvents(marker);
        }

        async function fetchAddress(lat, lng) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
            document.body.style.cursor = "wait";

            try {
                const response = await fetch(url, { headers: { 'User-Agent': 'IntranetACJOGOS/1.0' } });
                const data = await response.json();

                if (data && data.address) {
                    const addr = data.address;
                    if (elements.cep) elements.cep.value = addr.postcode || '';
                    if (elements.endereco) elements.endereco.value = addr.road || '';
                    if (elements.numero) elements.numero.value = addr.house_number || '';
                    if (elements.bairro) elements.bairro.value = addr.suburb || addr.neighbourhood || addr.residential || '';
                    if (elements.cidade) elements.cidade.value = addr.city || addr.town || addr.municipality || '';
                    if (elements.estado && addr.state) elements.estado.value = convertStateToSigla(addr.state);
                }
            } catch (error) {
                console.error("Erro ao buscar endereço:", error);
            } finally {
                document.body.style.cursor = "default";
            }
        }

        function convertStateToSigla(stateName) {
            const map = {
                "Rio de Janeiro": "RJ", "São Paulo": "SP", "Minas Gerais": "MG", "Espírito Santo": "ES",
                "Bahia": "BA", "Distrito Federal": "DF", "Paraná": "PR", "Rio Grande do Sul": "RS",
                "Santa Catarina": "SC", "Pernambuco": "PE", "Ceará": "CE", "Goiás": "GO"
            };
            return map[stateName] || stateName.substring(0, 2).toUpperCase();
        }

        function setupMarkerEvents(markerInstance) {
            markerInstance.on('dragend', function (event) {
                var position = markerInstance.getLatLng();
                updateInputs(position.lat, position.lng);
                fetchAddress(position.lat, position.lng);
            });
        }

        function updateInputs(lat, lng) {
            if (elements.lat) elements.lat.value = lat.toFixed(6);
            if (elements.lng) elements.lng.value = lng.toFixed(6);
        }

        map.on('click', function (e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                marker = L.marker([lat, lng], {
                    icon: redIcon,
                    draggable: true
                }).addTo(map);
                setupMarkerEvents(marker);
            }
            updateInputs(lat, lng);
            fetchAddress(lat, lng);
        });
    });
</script>
{% endblock %}